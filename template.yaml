apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: playground
  description: |
    This accelerator provides Terraform modules to provision Databricks workspaces,
        compute, Unity Catalog, metastores, and security configurations, designed to be
        composed together for tailored deployments.
  tags:
    - databricks
    - terraform
    - aws
    - oidc
spec:
  owner: group:accelerator-publisher
  type: service
  parameters:
    - title: Module Selection
      properties:
        isWorkspaceEnabled:
          title: Enable Workspace Module?
          type: boolean
          default: false
        isCatalogEnabled:
          title: Enable Catalog Module?
          type: boolean
          default: false
        isComputeEnabled:
          title: Enable Compute Module?
          type: boolean
          default: false
        isSecurityEnabled:
          title: Enable Security Module?
          type: boolean
          default: false
        isCiCdEnabled:
          title: Enable CI/CD Module?
          type: boolean
          default: false

    - if: ${{ parameters.isWorkspaceEnabled }}
      title: Workspace Configuration
      properties:
        databricksCrossAccountPolicyType:
          type: string
          title: Cross Account Policy Type
          default: customer
        databricksStorages:
          title: Databricks Storage
          type: array
          minItems: 1
          ui:options:
            addable: true
            orderable: true
            removable: true
          items:
            type: object
            properties:
              name:
                title: Name
                type: string
              s3_prefix:
                title: S3 prefix
                type: string
          default:
            - name: main
              s3_prefix: thoughtworks
            - name: finance
        databricksEncryptions:
          title: Databricks Encryptions
          type: array
          minItems: 1
          ui:options:
            addable: true
            orderable: true
            removable: true
            expandable: true
          items:
            type: object
            properties:
              name:
                title: Name
                type: string
              use_cases:
                title: Use Cases
                type: array
                items:
                  type: string
                  enum:
                    - MANAGED_SERVICES
                    - STORAGE
                uniqueItems: true
                ui:widget: checkboxes
          default:
            - name: main
              use_cases: 
                - MANAGED_SERVICES
                - STORAGE
            - name: dbfs
              use_cases: 
                - MANAGED_SERVICES
        workspaceConfiguration:
          title: Workspace
          type: array
          minItems: 1
          ui:options:
            addable: true
            orderable: true
            removable: true
            expandable: true
          items:
            type: object
            properties:
              name:
                title: Name
                type: string
              storage:
                title: Storage
                type: string
                enum: ["main", "finance"]  
              network:
                title: Network
                type: string
              private_access:
                title: Private Access
                type: boolean
                ui:widget: radio
              encryption:
                title: Encryption
                type: object
                properties:
                  storage:
                    title: Storage
                    type: string
          default:
            - name: thoughtworks-main
              storage: main
              network: main
              private_access: true
              encryption:
                storage: dbfs
            - name: thoughtworks-finance
              storage: finance
              network: finance
        clustersConfiguration:
          title: Clusters
          type: array
          minItems: 1
          ui:options:
            addable: true
            orderable: true
            removable: true
            expandable: true
          items:
            type: object
            properties:
              name:
                title: Name
                type: string
              spark_version:
                title: Spark Version
                type: string
              photon:
                title: Enable Photon
                type: boolean
              driver_instance_type:
                title: Driver Instance Type
                type: string
              instance_type:
                title: Worker Instance Type
                type: string
              spark_conf:
                title: Spark Configuration
                type: object
                properties:
                  spark_app_name:
                    title: Spark App Name
                    type: string
              on_demand:
                title: On-Demand Configuration
                type: object
                properties:
                  composition:
                    title: Composition
                    type: string
                    enum: [DRIVER_ONLY]
                  bid_price_percentage:
                    title: Bid Price Percentage
                    type: integer
              auto_terminate:
                title: Auto Terminate (minutes)
                type: integer
          default:
            - name: Shared Cluster
              spark_version: LTS
              photon: true
              driver_instance_type: m5.large
              instance_type: m5.xlarge
              spark_conf:
                spark_app_name: general_tasks
              on_demand:
                composition: DRIVER_ONLY
                bid_price_percentage: 100
              auto_terminate: 60
        sqlWarehousesConfiguration:
          title: SQL Warehouses
          type: array
          minItems: 1
          ui:options:
            addable: true
            orderable: true
            removable: true
            expandable: true
          items:
            type: object
            properties:
              name:
                title: Name
                type: string
              size:
                title: Size
                type: string
                enum: [Small, Medium, Large]
              photon:
                title: Enable Photon
                type: boolean
              serverless:
                title: Enable Serverless
                type: boolean
              min_clusters:
                title: Minimum Clusters
                type: integer
              max_clusters:
                title: Maximum Clusters
                type: integer
              spot_instance_policy:
                title: Spot Instance Policy
                type: string
                enum: [COST_OPTIMIZED, RELIABILITY_OPTIMIZED]
              auto_terminate:
                title: Auto Terminate (minutes)
                type: integer
          default:
            - name: SQL Shared
              size: Small
              photon: true
              serverless: true
              min_clusters: 2
              max_clusters: 3
              spot_instance_policy: COST_OPTIMIZED
              auto_terminate: 60

    - if: ${{ parameters.isCatalogEnabled }}
      title: Catalog Configuration
      properties:
        catalogConfiguration:
          title: Catalog Configuration
          type: array
          minItems: 1
          ui:options:
            addable: true
            orderable: true
            removable: true
            expandable: true
          items:
            type: object
            properties:
              name:
                title: Name
                type: string
              storage:
                title: Storage
                type: object
                properties:
                  s3_prefix:
                    title: S3 Prefix
                    type: string
                    default: thoughtworks
              prefix:
                title: Prefix Control
                type: boolean
                ui:widget: radio
            required:
              - prefix
            dependencies:
              prefix:
                allOf:
                  - if:
                      properties:
                        prefix:
                          const: true
                    then:
                      properties:
                        visible:
                          title: Visible Control
                          type: boolean
                          ui:widget: radio
                        isolated:
                          title: Isolated Control
                          type: boolean
                          ui:widget: radio
                        schemas:
                          type: array
                          title: Select Schemas to be Deployed
                          items:
                            type: string
                            enum:
                              - bronze
                              - silver
                              - gold
                          uniqueItems: true
                          ui:widget: checkboxes
          default:
            - name: development
              prefix: false
              storage:
                s3_prefix: thoughtworks
            - name: demo
              prefix: true
              storage:
                s3_prefix: thoughtworks
              visible: true
              isolated: false
              schemas:
                - bronze
                - silver
                - gold

        externalLocationConfiguration:
          title: External Location
          type: array
          minItems: 1
          ui:options:
            addable: true
            orderable: true
            removable: true
            expandable: true
          items:
            type: object
            properties:
              name:
                title: Name
                type: string
              storage:
                title: Storage
                type: object
                properties:
                  create_bucket:
                    name: Create Bucket?
                    type: boolean
                    ui:widget: radio
                required:
                  - create_bucket
                dependencies:
                  create_bucket:
                    allOf:
                      - if:
                          properties:
                            create_bucket:
                              const: false
                        then:
                          properties:
                            s3_bucket:
                              title: S3 Bucket
                              type: string
                            s3_kms_key:
                              title: S3 KMS Key
                              type: string
                      - if:
                          properties:
                            create_bucket:
                              const: true
                        then:
                          properties:
                            s3_prefix:
                              title: S3 Prefix
                              type: string
          default:
            - name: demo
              storage:
                create_bucket: true
                s3_prefix: thoughtworks
            - name: existing
              storage:
                create_bucket: false
                s3_bucket: databricks-thoughtworks-existing-bucket
                s3_kms_key: databricks-thoughtworks-existing-bucket

    - if: ${{ parameters.isComputeEnabled }}
      title: Compute Configuration
      properties:
        compute:
          title: Configuration
          type: object
          properties:
            databricksCredential:
              title: Databricks Credential
              type: object
              properties:
                databricksCrossAccountPolicyType:
                  type: string
                  title: Cross Account Policy Type
                  default: customer
            databricksStorages:
              title: Databricks Storage
              type: array
              minItems: 1
              ui:options:
                addable: true
                orderable: true
                removable: true
              items:
                type: object
                properties:
                  name:
                    title: Name
                    type: string
                  s3_prefix:
                    title: S3 prefix
                    type: string
              default:
                - name: main
                  s3_prefix: thoughtworks
                - name: finance
            databricksEncryptions:
              title: Databricks Encryptions
              type: array
              minItems: 1
              ui:options:
                addable: true
                orderable: true
                removable: true
                expandable: true
              items:
                type: object
                properties:
                  name:
                    title: Name
                    type: string
                  use_cases:
                    title: Use Cases
                    type: array
                    items:
                      type: string
                      enum:
                        - MANAGED_SERVICES
                        - STORAGE
                    uniqueItems: true
                    ui:widget: checkboxes
              default:
                - name: main
                  use_cases: 
                    - MANAGED_SERVICES
                    - STORAGE
                - name: dbfs
                  use_cases: 
                    - MANAGED_SERVICES

    - if: ${{ parameters.isSecurityEnabled }}
      title: Security Configuration
      properties:
        security:
          type: object
          title: Security Profile Configuration
          properties:
            compliance_standards:
              title: Compliance Standards
              type: array
              description: Select applicable compliance standards
              items:
                type: string
                enum:
                  - HIPAA
                  - PCI-DSS
                  - SOX
                  - GDPR
                  - SOC2
              uniqueItems: true
              ui:widget: checkboxes
              ui:options:
                inline: true

            encryption:
              title: Encryption Settings
              type: object
              description: Configure encryption requirements
              properties:
                enforce_encryption_at_rest:
                  type: boolean
                  title: Enforce Encryption at Rest
                  default: true
                enforce_encryption_in_transit:
                  type: boolean
                  title: Enforce Encryption in Transit
                  default: true
                customer_managed_keys:
                  type: boolean
                  title: Use Customer Managed Keys
                  default: false

            network_security:
              title: Network Security Settings
              type: object
              description: Configure network security policies
              properties:
                private_link_enabled:
                  type: boolean
                  title: Enable Private Link
                  default: false
                ip_access_lists:
                  title: IP Access Lists
                  type: array
                  description: Configure IP access control lists
                  items:
                    type: object
                    required:
                      - label
                      - ip_addresses
                      - list_type
                    properties:
                      label:
                        type: string
                        title: Label
                      ip_addresses:
                        type: array
                        title: IP Addresses/CIDR Blocks
                        items:
                          type: string
                          pattern: '^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(?:/(?:[0-9]|[1-2][0-9]|3[0-2]))?$'
                          description: IP address or CIDR block (e.g., 192.168.1.0/24)
                      list_type:
                        type: string
                        enum: [ALLOW, BLOCK]
                        default: ALLOW
                        title: List Type
                  ui:options:
                    addable: true
                    removable: true

        advanced_security:
          type: object
          title: Advanced Security Features
          properties:
            audit_logging:
              title: Audit Logging Configuration
              type: object
              properties:
                enabled:
                  type: boolean
                  title: Enable Audit Logging
                  default: true
                log_retention_days:
                  type: integer
                  title: Log Retention Period (Days)
                  minimum: 30
                  maximum: 2555
                  default: 90
                export_to_s3:
                  type: boolean
                  title: Export Logs to S3
                  default: false

            monitoring:
              title: Security Monitoring
              type: object
              properties:
                enable_threat_detection:
                  type: boolean
                  title: Enable Threat Detection
                  default: false
                enable_anomaly_detection:
                  type: boolean
                  title: Enable Anomaly Detection
                  default: false

            access_control:
              title: Access Control Settings
              type: object
              properties:
                enforce_mfa:
                  type: boolean
                  title: Enforce Multi-Factor Authentication
                  default: false
                session_timeout_minutes:
                  type: integer
                  title: Session Timeout (Minutes)
                  minimum: 15
                  maximum: 1440
                  default: 480
                max_concurrent_sessions:
                  type: integer
                  title: Maximum Concurrent Sessions
                  minimum: 1
                  maximum: 10
                  default: 3

    - if: ${{ parameters.isCiCdEnabled }}
      title: CI/CD Configuration
      properties:
        repoUrl:
          title: Target Repository Location
          type: string
          ui:field: RepoUrlPicker
          ui:options:
            requestUserCredentials:
              secretsKey: USER_OAUTH_TOKEN
              additionalScopes:
                github:
                  - workflow
            allowedHosts:
              - github.com
        tfStateBucket:
          title: Terraform State S3 Bucket Name
          type: string
          description: "Name of the S3 bucket to store Terraform state files."
        appS3BucketName:
          title: Application S3 Bucket Name
          type: string
          description: "Name of the main S3 bucket for application data storage."
        awsRegion:
          title: AWS Region
          type: string
          description: "AWS region for deploying resources and for the S3 state bucket (e.g., us-west-1)."
          default: us-west-1
        awsOidcRoleArn:
          title: AWS OIDC Role ARN
          type: string
          description: "ARN of the IAM Role for GitHub Actions OIDC authentication (e.g., arn:aws:iam::123456789012:role/GitHubActionsRole)."
        databricksAccountId:
          title: Databricks Account Id
          type: string
          description: "Account ID of the Databricks"
        databricksHost:
          title: Databricks Host
          type: string
          description: "Databricks workspace URL (e.g., https://dbc-12345678-abcd.cloud.databricks.com)"
        databricksClientId:
          title: Databricks Client ID
          type: string
          description: "Client ID for the Databricks Service Principal."
        databricksClientSecret:
          title: Databricks Client Secret
          type: string
          description: "Client Secret for the Databricks Service Principal."
          ui:field: Secret

  steps:
    - id: fetch-base
      name: Fetch Base
      action: fetch:plain
      input:
        url: ./skeleton
  
    - id: publish
      name: Publish to GitHub
      action: publish:github
      input:
        allowedHosts: [ 'github.com' ]
        repoUrl: ${{ parameters.repoUrl }}
        repoVisibility: private
        defaultBranch: main
        token: ${{ secrets.USER_OAUTH_TOKEN or false }}
        description: Databricks Terraform Accelerator
        secrets:
          DATABRICKS_CLIENT_SECRET: ${{ secrets.databricksClientSecret }}
        repoVariables:
          DATABRICKS_HOST: ${{ parameters.databricksHost }}
          DATABRICKS_CLIENT_ID: ${{ parameters.databricksClientId }}
          AWS_REGION: ${{ parameters.awsRegion }}
          AWS_ROLE_TO_ASSUME: ${{ parameters.awsOidcRoleArn }}
          TF_BACKEND_BUCKET: ${{ parameters.tfStateBucket }}
          TF_VAR_s3_bucket_name_main: ${{ parameters.appS3BucketName }}   

  output:
    links:
      - title: GitHub Repository
        icon: github
        url: ${{ steps.publish.output.remoteUrl }}
